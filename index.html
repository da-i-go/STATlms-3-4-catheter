<!DOCTYPE html>
<html lang="ja">
<head>
  <meta name="robots" content="noindex, nofollow"/>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>STAT画像学習システム</title>
  <link rel="stylesheet" href="css/index.css"/>
</head>
<body>
  <main style="max-width:480px;margin:8vh auto;padding:24px;border:1px solid #ddd;border-radius:12px;">
    <h1>ログイン</h1>
    <p>職員IDを入力してください。</p>
    <form id="loginForm">
      <input name="uid" placeholder="例: AK1234" required
             style="width:100%;padding:12px;border:1px solid #ccc;border-radius:8px;margin:12px 0;">
      <button type="submit" style="width:100%;padding:12px;border:0;border-radius:8px;background:#1976d2;color:#fff;">
        入室する
      </button>
    </form>
  </main>

  <script>
  const API = 'https://script.google.com/macros/s/AKfycbxZP5jL90wjUA80D_XxGO1IyEwCrEmW4TB-n_Y999lHVUQ9OgUIErIbGBEWlbPJfj8-/exec';

  document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    let uid = new FormData(e.target).get('uid') || '';
    uid = uid.replace(/[Ａ-Ｚａ-ｚ０-９]/g, s => String.fromCharCode(s.charCodeAt(0)-0xFEE0))
             .replace(/\s+/g,'')
             .trim();
    if (!uid) return alert('IDを入力してください');

    // ★テスト用ショートカット：9999なら常に通過（あとで削除OK）
    if (uid === '9999') {
      sessionStorage.setItem('authenticated', 'true');
      sessionStorage.setItem('uid', uid);
      sessionStorage.setItem('name', 'テストユーザー');
      location.replace('patient.html');
      return;
    }

    try {
      const r = await fetch(API + '?route=verify', {
        method: 'POST',
        headers: { 'Content-Type':'text/plain;charset=utf-8' }, // プリフライト回避
        body: JSON.stringify({ uid })
      });
      if (!r.ok) throw new Error('HTTP ' + r.status);
      const j = await r.json();

      if (j.ok) {
        sessionStorage.setItem('authenticated','true');
        sessionStorage.setItem('uid', uid);
        if (j.name) sessionStorage.setItem('name', j.name);
        location.replace('patient.html');
      } else {
        alert(j.error || 'IDが無効です');
      }
    } catch(err){
      console.error(err);
      alert('通信エラー。時間をおいて再試行してください。');
    }
  });
</script>

</body>
</html>
