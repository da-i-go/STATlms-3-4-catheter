<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta name="robots" content="noindex, nofollow" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>STATç”»åƒå­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ </title>
    <link href="css/viewer.css" rel="stylesheet" />
    
    <script>
      // æœªèªè¨¼ãªã‚‰ãƒ­ã‚°ã‚¤ãƒ³ã¸
      if (sessionStorage.getItem("authenticated") !== "true") {
        location.replace("index.html");
      } 
    </script>
  </head>

  <body>
    <div id="loadingOverlay">
      <div class="spinner"></div>
      <div class="loading-text">Loading...</div>
    </div>

    <main style="display: none">
      <h1 id="setTitle">æ¤œæŸ»ç”»åƒ</h1>

      <div class="set-buttons" id="setButtonsContainer"></div>

      <!-- ç”»åƒãƒ“ãƒ¥ãƒ¼ã‚¢ -->
      <div class="viewer">
        <img alt="CT Slice" id="ctImage" src="" />

        <!-- å³ä¸‹ï¼šå…¨ç”»é¢ãƒœã‚¿ãƒ³ -->
        <button id="enterFsBtn" class="fullscreen-btn" aria-label="å…¨ç”»é¢è¡¨ç¤º">
            [ å…¨ç”»é¢ ]
        </button>
      </div>

      <!--  ã‚ºãƒ¼ãƒ  -->
      <div class="zoom-controls" aria-label="ã‚ºãƒ¼ãƒ æ“ä½œ">
        <button type="button" id="zoomOutBtn" class="zoom-button" aria-label="ç¸®å°">ğŸ”ï¼</button>
        <span id="zoomLevel" class="zoom-level" aria-live="polite" aria-atomic="true">100%</span>
        <button type="button" id="zoomInBtn" class="zoom-button" aria-label="æ‹¡å¤§">ğŸ”ï¼‹</button>
      </div>

      <!-- â–¼ ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ï¼ˆé€šå¸¸è¡¨ç¤ºï¼‰ -->
      <div class="slider-container">
        <button class="arrow-button" id="prevBtn">â†</button>
        <input id="sliceSlider" min="1" step="1" type="range" />
        <button class="arrow-button" id="nextBtn">â†’</button>
      </div>

      <div class="slice-info" id="sliceInfo">ç¾åœ¨ã®ã‚¹ãƒ©ã‚¤ã‚¹: 1</div>

      <div class="navigation">
        <button onclick="location.href='answer3-1.html'">
          <span class="icon">â–¶</span><span class="label">è§£ç­”</span>
        </button>
      </div>
    </main>

    <!-- ===== ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ç”¨ãƒ©ã‚¤ãƒˆãƒœãƒƒã‚¯ã‚¹ ===== -->
    <div id="lightbox" class="lightbox" aria-hidden="true" role="dialog" aria-modal="true">
      <div class="lightbox-backdrop" id="lightboxBackdrop"></div>
      <div class="lightbox-content" role="document">
        <button id="closeFsBtn" class="lightbox-close" aria-label="é–‰ã˜ã‚‹">Ã—</button>

        <div class="lightbox-viewer">
          <img alt="CT Slice (fullscreen)" id="ctImageFs" src="" />
        </div>

        <!-- ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ï¼ˆãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ç”¨ï¼‰ -->
        <div class="slider-container slider-container-fs">
          <button class="arrow-button" id="prevBtnFs">â†</button>
          <input id="sliceSliderFs" min="1" step="1" type="range" />
          <button class="arrow-button" id="nextBtnFs">â†’</button>
        </div>
      </div>
    </div>
    
    
    <script>
      /* ========== å…ƒã®çŠ¶æ…‹ç®¡ç† ========== */
      const imageSets = {
        Xp: { label: "ãƒ¬ãƒ³ãƒˆã‚²ãƒ³", totalSlices: 1, padding: 5 },
        "CT-tra": { label: "é€ å½±CT", totalSlices: 177, padding: 5 },
        "CT-lung": { label: "CTè‚º", totalSlices: 79, padding: 5 },
        "CT-cor": { label: "corç”»åƒ", totalSlices: 109, padding: 5 },
      };

      let currentSet = "Xp"; // â† å¿…è¦ã«å¿œã˜ã¦åˆæœŸå€¤ã‚’å¤‰æ›´
      let currentSlice = 1;
      const imageCache = {};

      const ctImage = document.getElementById("ctImage");
      const slider = document.getElementById("sliceSlider");
      const info = document.getElementById("sliceInfo");
      const title = document.getElementById("setTitle");
      const loadingOverlay = document.getElementById("loadingOverlay");
      const mainContent = document.querySelector("main");
      const setButtonsContainer = document.getElementById("setButtonsContainer");

      function getImageFilename(n, set = currentSet) {
        const padding = imageSets[set].padding || 0;
        const padded = String(n).padStart(padding, "0");
        return `${set}/${set}-${padded}.JPG`;
      }

      function preloadImages(set, callback) {
        if (imageCache[set]) { callback(); return; }
        const { totalSlices } = imageSets[set];
        imageCache[set] = [];
        let loaded = 0;
        for (let i = 1; i <= totalSlices; i++) {
          const img = new Image();
          img.onload = img.onerror = () => {
            loaded++;
            if (loaded === totalSlices) callback();
          };
          img.src = getImageFilename(i, set);
          imageCache[set][i] = img;
        }
      }

      function applySliceToImgs(n){
        const img = imageCache[currentSet]?.[n];
        const src = img?.src || getImageFilename(n);
        ctImage.src = src;
        // FSå´ã«ã‚‚åæ˜ 
        const fsImg = document.getElementById("ctImageFs");
        if (fsImg) fsImg.src = src;
      }

      function updateSlice(n) {
        const total = imageSets[currentSet].totalSlices;
        currentSlice = n;
        applySliceToImgs(n);
        info.textContent = `ç¾åœ¨ã®ã‚¹ãƒ©ã‚¤ã‚¹: ${n} / ${total}`;
        slider.value = n;
        // FSã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚‚åŒæœŸ
        const sliderFs = document.getElementById("sliceSliderFs");
        if (sliderFs) sliderFs.value = n;
      }

      function changeSlice(step) {
        const total = imageSets[currentSet].totalSlices;
        const newSlice = Math.max(1, Math.min(total, currentSlice + step));
        updateSlice(newSlice);
      }

      function switchImageSetTo(setName) {
        loadingOverlay.style.display = "flex";
        mainContent.style.display = "none";
        currentSet = setName;
        currentSlice = 1;

        slider.max = imageSets[setName].totalSlices;
        slider.value = currentSlice;

        // FSå´ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®maxã‚‚æ›´æ–°
        const sliderFs = document.getElementById("sliceSliderFs");
        if (sliderFs) sliderFs.max = imageSets[setName].totalSlices;

        preloadImages(currentSet, () => {
          loadingOverlay.style.display = "none";
          mainContent.style.display = "flex";
          updateSlice(currentSlice);
          updateButtonStates();
        });
      }

      function createSetButtons() {
        for (const key in imageSets) {
          const btn = document.createElement("button");
          btn.textContent = imageSets[key].label;
          btn.className = "set-button";
          btn.dataset.setKey = key;
          btn.addEventListener("click", () => switchImageSetTo(key));
          setButtonsContainer.appendChild(btn);
        }
      }

      function updateButtonStates() {
        const buttons = setButtonsContainer.querySelectorAll(".set-button");
        buttons.forEach((btn) => {
          const key = btn.dataset.setKey;
          if (key === currentSet) {
            btn.disabled = true;
            btn.innerHTML = `âœ”ï¸ ${imageSets[key].label}`;
          } else {
            btn.disabled = false;
            btn.innerHTML = imageSets[key].label;
          }
        });
      }

      /* ========== ã‚ºãƒ¼ãƒ  & ãƒ‰ãƒ©ãƒƒã‚° ========== */
      let zoomScale = 1;
      const MIN_ZOOM = 0.5;
      const MAX_ZOOM = 4;
      const STEP_ZOOM = 0.2;

      let offsetX = 0, offsetY = 0, startX = 0, startY = 0, isDragging = false;

      const zoomLevelEl = document.getElementById("zoomLevel");
      const zoomInBtn = document.getElementById("zoomInBtn");
      const zoomOutBtn = document.getElementById("zoomOutBtn");

      function applyZoom() {
        ctImage.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${zoomScale})`;
        zoomLevelEl.textContent = `${Math.round(zoomScale * 100)}%`;
      }

      function setZoom(next) {
        zoomScale = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, next));
        if (zoomScale <= 1) { offsetX = 0; offsetY = 0; }
        applyZoom();
      }
      function zoomIn() { setZoom(zoomScale + STEP_ZOOM); }
      function zoomOut() { setZoom(zoomScale - STEP_ZOOM); }
      function resetZoom() { zoomScale = 1; offsetX = 0; offsetY = 0; applyZoom(); }

      function clampOffsets() {
        const rect = document.querySelector(".viewer").getBoundingClientRect();
        const imgWidth = rect.width * zoomScale;
        const imgHeight = rect.height * zoomScale;
        const maxX = (imgWidth - rect.width) / 2;
        const maxY = (imgHeight - rect.height) / 2;
        offsetX = Math.max(-maxX, Math.min(maxX, offsetX));
        offsetY = Math.max(-maxY, Math.min(maxY, offsetY));
      }

      ctImage.addEventListener("mousedown", (e) => {
        if (zoomScale <= 1) return;
        e.preventDefault();
        isDragging = true;
        startX = e.clientX; startY = e.clientY;
        ctImage.style.cursor = "grabbing";
      });
      window.addEventListener("mousemove", (e) => {
        if (!isDragging) return;
        e.preventDefault();
        const dx = e.clientX - startX, dy = e.clientY - startY;
        startX = e.clientX; startY = e.clientY;
        offsetX += dx; offsetY += dy;
        clampOffsets(); applyZoom();
      });
      window.addEventListener("mouseup", () => { isDragging = false; ctImage.style.cursor = "grab"; });

      // ã‚¿ãƒƒãƒ
      let lastTouchX = 0, lastTouchY = 0;
      ctImage.addEventListener("touchstart", (e) => {
        if (zoomScale <= 1) return;
        if (e.touches.length !== 1) return;
        const t = e.touches[0];
        lastTouchX = t.clientX; lastTouchY = t.clientY;
      });
      ctImage.addEventListener("touchmove", (e) => {
        if (zoomScale <= 1) return;
        if (e.touches.length !== 1) return;
        e.preventDefault();
        const t = e.touches[0];
        const dx = t.clientX - lastTouchX, dy = t.clientY - lastTouchY;
        lastTouchX = t.clientX; lastTouchY = t.clientY;
        offsetX += dx; offsetY += dy; clampOffsets(); applyZoom();
      });

      zoomInBtn.addEventListener("click", zoomIn);
      zoomOutBtn.addEventListener("click", zoomOut);

      // ç”»åƒã‚»ãƒƒãƒˆåˆ‡æ›¿æ™‚ã«å€ç‡ãƒªã‚»ãƒƒãƒˆ
      const _origSwitchSet = switchImageSetTo;
      switchImageSetTo = function (setName) {
        _origSwitchSet(setName);
        resetZoom();
      };

      /* ========== ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼æ“ä½œï¼ˆé€šå¸¸ï¼‰ ========== */
      document.getElementById("prevBtn").addEventListener("click", () => changeSlice(-1));
      document.getElementById("nextBtn").addEventListener("click", () => changeSlice(1));
      slider.addEventListener("input", (e) => updateSlice(parseInt(e.target.value, 10)));

      /* ========== ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ï¼ˆãƒ©ã‚¤ãƒˆãƒœãƒƒã‚¯ã‚¹ï¼‰ ========== */
      const lightbox = document.getElementById("lightbox");
      const backdrop = document.getElementById("lightboxBackdrop");
      const enterFsBtn = document.getElementById("enterFsBtn");
      const closeFsBtn = document.getElementById("closeFsBtn");
      const sliderFs = document.getElementById("sliceSliderFs");
      const prevBtnFs = document.getElementById("prevBtnFs");
      const nextBtnFs = document.getElementById("nextBtnFs");

      function openFullscreen() {
        // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼max/å€¤ã‚’åŒæœŸ
        sliderFs.max = imageSets[currentSet].totalSlices;
        sliderFs.value = currentSlice;
        applySliceToImgs(currentSlice);

        lightbox.classList.add("is-open");
        lightbox.setAttribute("aria-hidden", "false");
        document.body.style.overflow = "hidden"; // èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æŠ‘æ­¢
        window.addEventListener("keydown", onKeydownEsc);
      }

      function closeFullscreen() {
        lightbox.classList.remove("is-open");
        lightbox.setAttribute("aria-hidden", "true");
        document.body.style.overflow = "";
        window.removeEventListener("keydown", onKeydownEsc);
      }

      function onKeydownEsc(e){
        if (e.key === "Escape") closeFullscreen();
      }

      enterFsBtn.addEventListener("click", openFullscreen);
      closeFsBtn.addEventListener("click", closeFullscreen);
      backdrop.addEventListener("click", closeFullscreen);

      // FSå´ã®æ“ä½œ â†’ çŠ¶æ…‹å…±æœ‰
      prevBtnFs.addEventListener("click", () => changeSlice(-1));
      nextBtnFs.addEventListener("click", () => changeSlice(1));
      sliderFs.addEventListener("input", (e) => updateSlice(parseInt(e.target.value, 10)));

      /* ========== åˆæœŸè¡¨ç¤º ========== */
      window.onload = () => {
        createSetButtons();
        updateButtonStates();
        preloadImages(currentSet, () => {
          loadingOverlay.style.display = "none";
          mainContent.style.display = "flex";
          updateSlice(currentSlice);
          applyZoom(); // åˆæœŸè¡¨ç¤ºã®ã‚ºãƒ¼ãƒ è¡¨ç¤ºåŒæœŸ
        });
      };
    </script>
  </body>
</html>
