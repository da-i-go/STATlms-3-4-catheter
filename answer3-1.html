<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta name="robots" content="noindex, nofollow" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>診断結果</title>
    <link rel="stylesheet" href="css/answer.css" />
    <script>
      if (sessionStorage.getItem("authenticated") !== "true") {
        location.replace("index.html");
      }
    </script>
  </head>

  <body>
    <h1>診断結果</h1>

    <section class="result-section">
      <h2>■ 診断名</h2>
      <p>CV先端離断</p>
    </section>

    <section class="result-section">
      <h2>■ Key画像</h2>
      <div class="carousel-container">
        <div class="carousel-wrapper">
          <button class="carousel-button prev">❮</button>
          <div class="carousel-track-container">
            <ul class="carousel-track">
              <li class="carousel-slide">
                <img src="key-images/Xp-kako.JPG" alt="キー画像の説明" />
                <p class="caption">2ヶ月前のレントゲン画像</p>
              </li>
              <li class="carousel-slide">
                <img src="key-images/Xp.JPG" alt="キー画像２の説明" />
                <p class="caption">離断が発覚した日のレントゲン画像</p>
              </li>
            </ul>
          </div>
          <button class="carousel-button next">❯</button>
        </div>
        <div class="carousel-indicators"></div>
      </div>
    </section>

    <section class="result-section">
      <h2>■ 解説</h2>
      <div class="explanation">
        <p>帰宅していたため、緊急で呼び出しをした。</p>
        <p>カテーテルを問題なく抜去でき、退院された。</p>
      </div>
    </section>

    <!-- ページを閉じるボタン -->
    <div class="back-button">
      <button id="closeBtn">ページを閉じる</button>
    </div>

    <!-- スライド操作スクリプト -->
    <script>
      const track = document.querySelector(".carousel-track");
      const slides = Array.from(track.children);
      const nextButton = document.querySelector(".carousel-button.next");
      const prevButton = document.querySelector(".carousel-button.prev");
      const indicatorsContainer = document.querySelector(".carousel-indicators");

      slides.forEach((_, index) => {
        const dot = document.createElement("span");
        dot.classList.add("indicator");
        if (index === 0) dot.classList.add("active");
        dot.addEventListener("click", () => {
          currentIndex = index;
          updateSlidePosition();
        });
        indicatorsContainer.appendChild(dot);
      });

      const indicators = indicatorsContainer.querySelectorAll(".indicator");
      let currentIndex = 0;

      function updateSlidePosition() {
        const slideWidth = slides[0].getBoundingClientRect().width;
        track.style.transform = "translateX(-" + slideWidth * currentIndex + "px)";
        indicators.forEach((dot, index) => {
          dot.classList.toggle("active", index === currentIndex);
        });
      }

      nextButton.addEventListener("click", () => {
        currentIndex = (currentIndex + 1) % slides.length;
        updateSlidePosition();
      });

      prevButton.addEventListener("click", () => {
        currentIndex = (currentIndex - 1 + slides.length) % slides.length;
        updateSlidePosition();
      });

      // フリック対応
      let startX = 0;
      track.addEventListener("touchstart", (e) => {
        startX = e.touches[0].clientX;
      });

      track.addEventListener("touchend", (e) => {
        const endX = e.changedTouches[0].clientX;
        const diff = endX - startX;
        if (diff > 50) {
          currentIndex = (currentIndex - 1 + slides.length) % slides.length;
          updateSlidePosition();
        } else if (diff < -50) {
          currentIndex = (currentIndex + 1) % slides.length;
          updateSlidePosition();
        }
      });

      window.addEventListener("load", updateSlidePosition);
      window.addEventListener("resize", updateSlidePosition);
    </script>

    <!-- ページを閉じるボタンスクリプト -->
    <script>
      document.getElementById("closeBtn").addEventListener("click", () => {
        window.close();

        // もし閉じられなかった場合（普通のブラウザタブ）
        setTimeout(() => {
          if (!window.closed) {
            alert("このページを閉じて終了してください。");
          }
        }, 300);
      });
    </script>

    <!-- スプレッドシート記録スクリプト -->
    <script>
      (function () {
        if (sessionStorage.getItem("authenticated") !== "true") return;
        const API =
          "https://script.google.com/macros/s/AKfycbxZP5jL90wjUA80D_XxGO1IyEwCrEmW4TB-n_Y999lHVUQ9OgUIErIbGBEWlbPJfj8-/exec";
        const uid = sessionStorage.getItem("uid") || "anonymous";
        const page = location.pathname;
        const ts = new Date().toISOString();

        fetch(API + "?route=log", {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify({ uid, page, ts }),
        }).catch(console.warn);
      })();
    </script>
  </body>
</html>
